version: "3.7"

services:
  dis:
    build: .
    restart: always
    environment:
      CONFIG_PATH: ${CONFIG_PATH}
    labels:

      - "traefik.enable=True"
      - "eu.wiss-ki.barrel.distillery=${DOCKER_NETWORK_NAME}"
      - "traefik.http.routers.control.rule=${HOST_RULE}"

      - "traefik.http.routers.fallback.rule=HostRegexp(`{catchall:.*}`)"
      - "traefik.http.routers.fallback.priority=1"

      - "traefik.http.routers.control.tls=${HTTPS_ENABLED}"
      - "traefik.http.routers.control.tls.certresolver=distillery"
      - "traefik.http.services.control.loadbalancer.server.port=8888"


    volumes:
      # TODO: Mount docker socket properly!
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "${CONFIG_PATH}:${CONFIG_PATH}:ro"
      - "${DEPLOY_ROOT}:${DEPLOY_ROOT}:rw"
      - "${GLOBAL_AUTHORIZED_KEYS_FILE}:${GLOBAL_AUTHORIZED_KEYS_FILE}:ro"
      - "${SELF_OVERRIDES_FILE}:${SELF_OVERRIDES_FILE}:ro"
      - "${SELF_RESOLVER_BLOCK_FILE}:${SELF_RESOLVER_BLOCK_FILE}:ro"

networks:
  default:
    name: ${DOCKER_NETWORK_NAME}
    external: true
